<html>
<head>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="js/raphael-min.js"></script>
<script type="text/javascript" src="js/masonry.pkgd.min.js"></script>
<style>
.item { width: 25%;
	border: 1px solid black;
	margin: 5px;
	padding: 5px;
	}
.item.w1 { width: 20%; }
.item.w2 { width: 50%; }
.item.w3 { width: 70%; }
.item.w4 { width: 100%; }
</style>
<script>
$(document).ready(function() {


	var container = document.querySelector('#maincontainer');
	var msnry = new Masonry( container, {
	  // options
	  columnWidth: 150,
	  itemSelector: '.item'
	});

	var paper;

	var initialImageUrl = "http://images.metmuseum.org/CRDImages/es/web-large/DP105328.jpg";

	setupCanvas(function(paper){
		setupClickables(paper);
		setupStartingImage(paper, function(){console.log("starting image set")});
	});


	function setupClickables(_paper){
		$(".clicker").click(function(){
			var url=$("#urlvalue").val();
			var path = "/?imageurl="+encodeURIComponent(url);
			setImageInPaper(url, _paper, function(queueImage, morepaper){
				console.log(morepaper.scaleFactor);
				callCascader(path, function(data){
					placeIdentifiers(data, morepaper, morepaper.scaleFactor);
				});
			});
		});
	}

	function setupStartingImage(_paper, callback){
		setImageInPaper(initialImageUrl, _paper, callback);
	}

	function placeIdentifiers(data, _paper, scaleFactor){
		$(".controls").empty();
		console.log("placing identifiers");
		var _scaleFactor = scaleFactor;
		for(key in data){
			values = data[key];
			num_matches = values.length;
			var idname = "controlspan" + key;
			var checkid = "controlcheck" + key;
			if(num_matches > 0){
				var control = $("<span id='"+idname+"' class='control'>"+key+" ("+num_matches+")</span>");
				var controlCheck = $("<input id='"+checkid+"' type='checkbox' />");
				$(".controls").append(controlCheck).append(control).append("<BR>");
			}
			if(key != "_links"){
				for(key2 in values){
					value = values[key2];
					var x = value.x * _scaleFactor.scaleX;
					var y = value.y * _scaleFactor.scaleY;
					var w = value.w * _scaleFactor.scaleX;
					var h = value.h * _scaleFactor.scaleY;
					//var rect = _paper.rect(value.x, value.y, value.w, value.h);
					var rect = _paper.rect(x, y, w, h);

					rect.attr("stroke","#f00");
					rect.attr("stroke-width",1);
					rect.attr("fill", "#5f5");
					rect.attr("fill-opacity",".2");
					rect.toFront();
					rect.show();
					(function(_rectid, thepaper, _checkid){
						console.log("in anon");
						$(document).on("change", "#"+_checkid, function(){
							console.log("clicked" + _rectid);
							var _rect= thepaper.getById(_rectid);
							console.log(_rect);
							if($("#"+_checkid).is(':checked') ){
								console.log("showing");
								_rect.show();
								_rect.toFront();
							}else{
								console.log("hiding");
								_rect.hide();
							}
						});
					})(rect.id, _paper, checkid);
				}
			}
		}
	}

	function callCascader(url, callback){
		console.log("calling cascader url" + url);
		$.ajax(
			url,
			{
				success : function(data, status, jqXHR){
					console.log("success");
					console.log(data);
					callback(data);
					$("body").html($("body").html());
				},
				error : function(jqHXR, status, error){
					console.log("error");
					console.log(error);
				},

			}
		);

	}

});


function setupCanvas(callback){
	Raphael("imageholder", 400, 600, function(context){
		paper = this;
		callback(paper);
	});
}


function setImageInPaper(url, _paper, callback){
	_paper.clear();
	queueObject = {};

	data = {image: url};
	queueObject.data= data;

	var theimage= data.image;

	queueObject.image = theimage;
	queueObject.imageObj = new Image();
	queueObject.imageObj.onload = function(){
		queueObject.origWidth = queueObject.width;
		queueObject.origHeight = queueObject.height;

		var result = ScaleImage(queueObject.imageObj.width, queueObject.imageObj.height, 400, 600, true);
		queueObject.paperimage = _paper.image(queueObject.image, 0,0, result.width, result.height);
		queueObject.width = result.width;
		queueObject.height = result.height;
		_paper.scaleFactor = result;
		callback(queueObject, _paper, result);

	}
	queueObject.imageObj.src = queueObject.image;

}



  function ScaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox) {

    var result = { width: 0, height: 0, fScaleToTargetWidth: true };

    if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
        return result;
    }

    // scale to the target width
    var scaleX1 = targetwidth;
    var scaleY1 = (srcheight * targetwidth) / srcwidth;

    // scale to the target height
    var scaleX2 = (srcwidth * targetheight) / srcheight;
    var scaleY2 = targetheight;

		var scaleX;
		var scaleY;

    // now figure out which one we should use
    var fScaleOnWidth = (scaleX2 > targetwidth);
    if (fScaleOnWidth) {
        fScaleOnWidth = fLetterBox;
    }
    else {
       fScaleOnWidth = !fLetterBox;
    }

    if (fScaleOnWidth) {
        result.width = Math.floor(scaleX1);
        result.height = Math.floor(scaleY1);
        result.fScaleToTargetWidth = true;
    }
    else {
        result.width = Math.floor(scaleX2);
        result.height = Math.floor(scaleY2);
        result.fScaleToTargetWidth = false;
    }
		result.scaleX = result.width / srcwidth;
		result.scaleY = result.height / srcheight;
    result.targetleft = Math.floor((targetwidth - result.width) / 2);
    result.targettop = Math.floor((targetheight - result.height) / 2);

    return result;
  }



</script>
</head>
<body>
	<div id="maincontainer">
		<div class="urlinput item w4"><input id="urlvalue" type="text" size="120"/><span class="clicker">find stuff!</span></div>
		<div class="item w2">
			<div id="imageholder"></div>
		</div>
		<div class="controls item w1">controls</div>
</div>
</body>
</html>
