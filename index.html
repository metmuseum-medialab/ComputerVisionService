<html>
<head>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="js/raphael-min.js"></script>
<script>
$(document).ready(function() {

	var paper;

	var initialImageUrl = "http://images.metmuseum.org/CRDImages/es/web-large/DP105328.jpg";

	setupCanvas(function(paper){
		setupClickables(paper);
		setupStartingImage(paper, function(){console.log("starting image set")});
	});


	function setupClickables(_paper){
		$(".clicker").click(function(){
			var url=$("#urlvalue").val();
			var path = "/?imageurl="+encodeURIComponent(url);
			console.log("clicked");
			console.log(_paper);

			setImageInPaper(url, _paper, function(queueImage, _paper){
				console.log("calling cascader");
				console.log(_paper);
				callCascader(path, function(data){
					console.log("placing identifiers");
					console.log(_paper);
					placeIdentifiers(data, _paper);
				});
			});
		});
	}

	function setupStartingImage(_paper, callback){
		setImageInPaper(initialImageUrl, _paper, callback);
	}

	function placeIdentifiers(data, _paper){
		console.log("placing identifiers");
		$.each(data, function(key, values){
			console.log(key);
			if(key != "_links"){
				$.each(values, function(key2, value){
					console.log(value);
					console.log(paper);
					var rect = _paper.rect(value.x, value.y, value.width, value.height);

					rect.attr("stroke","#f00");
					rect.attr("stroke-width",1);
					rect.attr("fill", "#5f5");
					rect.attr("fill-opacity",".2");
					rect.toFront();
					rect.show();
					console.log(rect);
				});
			}
		});
	}

	function callCascader(url, callback){
		console.log("calling url");
		$.ajax(
			url,
			{
				success : function(data, status, jqXHR){
					console.log("success");
					console.log(data);
					callback(data);
					$("body").html($("body").html());
				},
				error : function(jqHXR, status, error){
					console.log("error");
					console.log(error);
				},

			}
		);

	}

});


function setupCanvas(callback){
	Raphael("imageholder", 400, 600, function(context){
		paper = this;
		callback(paper);
	});
}


function setImageInPaper(url, _paper, callback){
	_paper.clear();




	queueObject = {};

	console.log("loading " + url);

	data = {image: url};
	queueObject.data= data;

	var theimage= data.image;

	queueObject.image = theimage;
	queueObject.imageObj = new Image();
	queueObject.imageObj.onload = function(){
		console.log("loaded");
		var result = ScaleImage(queueObject.imageObj.width, queueObject.imageObj.height, 400, 600, true);
		console.log(result);
		console.log("paper is");
		console.log(paper);
	//	queueObject.paperimage = _paper.image(queueObject.image, 0,0, result.width, result.height);
		queueObject.width = result.width;
		queueObject.height = result.height;
		callback(queueObject, _paper);

	}
	queueObject.imageObj.src = queueObject.image;

}



  function ScaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox) {

    var result = { width: 0, height: 0, fScaleToTargetWidth: true };

    if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
        return result;
    }

    // scale to the target width
    var scaleX1 = targetwidth;
    var scaleY1 = (srcheight * targetwidth) / srcwidth;

    // scale to the target height
    var scaleX2 = (srcwidth * targetheight) / srcheight;
    var scaleY2 = targetheight;

    // now figure out which one we should use
    var fScaleOnWidth = (scaleX2 > targetwidth);
    if (fScaleOnWidth) {
        fScaleOnWidth = fLetterBox;
    }
    else {
       fScaleOnWidth = !fLetterBox;
    }

    if (fScaleOnWidth) {
        result.width = Math.floor(scaleX1);
        result.height = Math.floor(scaleY1);
        result.fScaleToTargetWidth = true;
    }
    else {
        result.width = Math.floor(scaleX2);
        result.height = Math.floor(scaleY2);
        result.fScaleToTargetWidth = false;
    }
    result.targetleft = Math.floor((targetwidth - result.width) / 2);
    result.targettop = Math.floor((targetheight - result.height) / 2);

    return result;
  }



</script>
</head>
<body>
<div class="urlinput"><input id="urlvalue" type="text" size="40"/><span class="clicker">find stuff!</span></div>
<div id="imageholder"></div>

<div class="controls">controls</div>

</body>
</html>
